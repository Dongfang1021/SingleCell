# 单细胞功能注释与富集
## 1 两类基因功能富集方法
### 1.1 基因功能富集分析
包括过代表分析ORA,功能分类打分FCS，基于通路拓扑结构PT和基于网络拓扑结构NT和基因富集分析GSEA。常用的是ORA和GSEA。
### 1.2 ORA（Over Representation Analysis）： 
也就是我们熟知的传统的基因富集方法，是一种超几何分布检验方法（Fisher‘s Excat Test），也就是常见的2*2方法。过表达分析（ORA）是一种广泛使用的方法，用于确定已知的动物功能或过程是否在实验衍生的基因列表中被过度表达（丰富），例如，差异表达基因列表（DEGs）

**传统的功能富集方法**
https://david.ncifcrf.gov/
![](image/ora.png)
N为所有基因中具有term注释的基因数目
n为N中差异表达基因的数目
M为所有基因中注释到某特定term条目的基因数目
m为注释到某特定term条目的差异表达基因数目
超几何分布(hypergeometric)是统计学上一种离散概率分布。它描述了由有限个物件中抽出n个物件，成功抽出指定种类的物件的个数（不归还）。超几何分布和Fisher‘s Exact Test是完全一模一样的原理，只是两种不同的称谓。

### 1.3 GSEA (Genes Set Enrichment Analysis)
ORA方法只考虑显著差异基因，经常尝试不同的cutoff，上调基因和下调基因分开富集。这种策略会因过高的阈值而忽略变化较小的基因，GSEA直接解决了这一局限性。所有基因均可用于GSEA，GSEA聚合了一个基因集内所有基因统计数据，因此能够以一种小而协调的方法检测预定义的基因集中所有基因的变化情况。
#### GSEA介绍
- GSEA是一种基于基因集（也可以理解某个term）的富集分析方法
- 基于基因表达数据与表型的关联度（也可以理解为表达量的变化，比如log2FC）的大小排序。
- 判断每个基因集内的基因是否富集与表型相关度排序后基因列表的上部或下部，从而判断此基因集内基因的协同变化对表型变化的影响。
#### GSEA原理与步骤
1. 背景基因排序
   将全部基因按照某种指标（差异分析p-value，表型相关性，表达量等）进行排序，比如Log2FC排序
2. 目标基因富集
   将某个特定类型的基因在排序表中标出。目标基因可以是某个通路或者GO terms的基因等
3. 计算富集分数
   使用加和法，计算ES值变化，将ES曲线最大值作为富集分数（Enrichment Score）
![](image/gsea.png)
![](image/gsea_1.png)
4. permutation test
   根据富集分数计算P值和FDR
   **permutation test的定义：** 评估富集得分（ES）的显著性。通过基于表型而不改变基因之间关系的排列检验（permutation test）计算观察到的富集得分（ES）出现的可能性，计算pvalue
   **permutation test的原理：** 
   - 假设： 全部基因集L有10000个，某通路基因有50个（目标基因集S），GSEA计算得到目标基因富集分数（ES）= 3
   - 采用随机抽样法，从10000个基因中抽取50个基因，构建虚拟目标基因集A，计算A的ES值。随机抽样10000此，从而得到虚拟ES值10000个。
   - 根据真实ES值在10000个虚拟ES中的位置，如果位于两端极端位置（例如，前top1%或后top1%），则说明S所计算出的ES值不是随机获得，而是显著偏大（说明基因集小中基因的排位靠前）或显著偏小（说明基因集S中基因的排位靠后）。真实的ES值对应位置，例如属于前50名，p=50/10000
#### GSEA结果图解析
![](image/gsea_2.png)
**Enrichment Score:** 最上面的绿线是遍历排好序的基因列表，是计算ES值的过程：遍历基因集L（背景gene set）， 当基因出现在S（目标基因）中加分，反之减分；加减分值由基因与表型的相关性决定。当分值积累到最大时就是富集分数。
Leading-edge subset：
对富集得分贡献最大的基因成员集
1: Enrichment score折线图
2：目标基因位置
3: 每个基因对应的信噪比
#### GSEA和ORA方法的比较
![](image/comparison.png)


## 1.4 基因功能注释数据库
收集了各种物种基因的功能注释的数据库，包括GO, KEGG， Reactome和MSigDB等常见基因功能注释数据库。
### 1.4.1 GO
http://geneontology.org/
GO(Gene Ontology)数据库：数据库由基因本体论联合会建立，该数据库将全世界所有与基因有关的研究结果进行分类汇总。对不同数据库中关于基因和基因产物的生物学术语进行标准化，对基因和蛋白功能进行统一的限定和描述。基因本体论定义了用来描述基因功能的概念/类，以及这些概念之间的关系。GO术语组织在一个有向无环图中，其中术语之间的边表示父子关系。
它将功能分为三个方面：BP（生物学过程biological process）， CC（细胞元件cellular component）和 MF（分子功能molecular function）。在这三个分支下面又分很多小层级（level），level级别数字越大，功能描述越细致（level1， level2，level3和level4）。通过GO注释，可以大致了解某个物种的全部基因产物的功能分类情况。
### 1.4.2 KEGG
http://www.genome.jp/kegg
KEGG（Kyoto Encyclopedia of Genes and Genomes）数据库，是由日本京都大学和东京大学联合开发的数据库，是基因组测序和其他高通量实验技术生成的大规模分子数据集的整合和解读的突出参考知识库，可以用查询代谢途径，酶（或编码酶的基因），产物等，也可以通过BLAST比对查询未知序列的代谢途径信息。
KEGG是一组人工绘制的代表分子相互作用和反应网络的通路图。这些途径涵盖了广泛的生化过程，可分为7大类：新陈代谢，遗传和环境信息处理，细胞过程，机体系统，人类疾病和药物开发。
## 2 多种基因注释数据库

## 3 windows平台下GSEA软件的应用
## 4 R环境下clusterProfiler包的应用
## 5 基因功能富集分析在单细胞的应用